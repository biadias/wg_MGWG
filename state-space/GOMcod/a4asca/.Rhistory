source('algorithm.R')
q()
library(FLa4a)
source('../../helper_code/a4a_funs.R')
#====================================================================
# read data
#====================================================================
setwd('../')
idxs <- readFLIndices('GOMCOD_survey.dat')
stk <- readFLStock('index.low', no.discards = TRUE)
stk <- setPlusGroup(stk, 9)
range(stk)[c('minfbar','maxfbar')] <- c(5,9)
setwd('a4asca')
#====================================================================
# replace 0 with half of the minimum
#====================================================================
catch.n(stk)[catch.n(stk)==0] <- min(catch.n(stk)[catch.n(stk)!=0])/2
idxs <- lapply(idxs, function(x){
index(x)[index(x)==0] <- min(index(x)[index(x)!=0])/2
x
})
#====================================================================
# Use only years with surveys
#====================================================================
my <- min(unlist(lapply(lapply(idxs, range), '[', 'minyear')))
stk <- window(stk, start=my)
qmod <- list(~s(age, k=3, by=breakpts(year, 2008)), ~s(age, k=3, by=breakpts(year, 2008))+year, ~s(age, k=3))
fmod <- ~s(year, k = 14, by = breakpts(age, c(0,2,4,8))) + s(age, k = 6)
srmod <- ~geomean(CV=0.3)
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod)
plot(residuals(fit, stk, idxs))
fit
fmod <- ~te(age, year, k = c(3, 17)) + s(age, k = 4)
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod)
plot(residuals(fit, stk, idxs))
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod, fmodel=fmod)
plot(residuals(fit, stk, idxs))
fmod <- ~te(age, year, k = c(3, 10)) + s(age, k = 4) + s(year, k=10, by=as.numeric(age %in% 1:4))
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod, fmodel=fmod)
plot(residuals(fit, stk, idxs))
fmod <- ~te(age, year, k = c(3, 10)) + s(age, k = 4) + s(year, k=10, by=as.numeric(age %in% 1:2))
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod, fmodel=fmod)
plot(residuals(fit, stk, idxs))
retro_gomcod <- function(stk, idxs, retro, k, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
KA <- unname(k['age'])
KA2 <- unname(k['age2'])
KY <- unname(k['year'] - floor(x/2))
fmod <- substitute(~te(age, year, k = c(KA, KY) + s(age, k = KA2) + s(year, k=KY, by=as.numeric(age %in% 1:2)), list(KA = KA, KY = KY, KA2 = KA2)))
args$fmodel <- as.formula(fmod)
fit <- do.call("sca", args)
args$stock + fit
})
FLStocks(lst0)
}
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=10, age2=4), qmodel=qmod, srmodel=srmod)
retro_gomcod <- function(stk, idxs, retro, k, ...){
args <- list(...)
lst0 <- split(0:retro, 0:retro)
lst0 <- lapply(lst0, function(x){
yr <- range(stk)["maxyear"] - x
args$stock <- window(stk, end=yr)
args$indices <- window(idxs, end=yr)
KA <- unname(k['age'])
KA2 <- unname(k['age2'])
KY <- unname(k['year'] - floor(x/2))
fmod <- substitute(~te(age, year, k = c(KA, KY)) + s(age, k = KA2) + s(year, k=KY, by=as.numeric(age %in% 1:2)), list(KA = KA, KY = KY, KA2 = KA2))
args$fmodel <- as.formula(fmod)
fit <- do.call("sca", args)
args$stock + fit
})
FLStocks(lst0)
}
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=10, age2=4), qmodel=qmod, srmodel=srmod)
fit.rm <- mohn(stk.retro)
plot(stk.retro)
stk
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=15, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=20, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=17, age2=4), qmodel=qmod, srmodel=srmod)
fit.rm <- mohn(stk.retro)
plot(stk.retro)
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=18, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
fit.rm <- mohn(stk.retro)
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=15, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
fit.rm
fit.rm <- mohn(stk.retro)
fit.rm
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=13, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
fit.rm <- mohn(stk.retro)
fit.rm
stk.retro <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=25, age2=4), qmodel=qmod, srmodel=srmod)
plot(stk.retro)
source('algorithm.R')
q()
library(FLa4a)
source('../../helper_code/a4a_funs.R')
#====================================================================
# read data
#====================================================================
setwd('../')
idxs <- readFLIndices('GOMCOD_survey.dat')
stk <- readFLStock('index.low', no.discards = TRUE)
stk <- setPlusGroup(stk, 9)
range(stk)[c('minfbar','maxfbar')] <- c(5,9)
setwd('a4asca')
#====================================================================
# replace 0 with half of the minimum
#====================================================================
catch.n(stk)[catch.n(stk)==0] <- min(catch.n(stk)[catch.n(stk)!=0])/2
idxs <- lapply(idxs, function(x){
index(x)[index(x)==0] <- min(index(x)[index(x)!=0])/2
x
})
#====================================================================
# Use only years with surveys
#====================================================================
my <- min(unlist(lapply(lapply(idxs, range), '[', 'minyear')))
stk <- window(stk, start=my)
#====================================================================
# run model
#====================================================================
qmod <- list(~s(age, k=3, by=breakpts(year, 2008)), ~s(age, k=3, by=breakpts(year, 2008))+year, ~s(age, k=3))
fmod <- ~te(age, year, k = c(3, 15)) + s(age, k = 4) + s(year, k=15, by=as.numeric(age %in% 1:2))
srmod <- ~geomean(CV=0.3)
fit <- sca(stk, idxs, qmodel=qmod, srmodel=srmod)
plot(residuals(fit, stk, idxs))
fmod <- ~te(age, year, k = c(3, 15)) + s(age, k = 4) + s(year, k=10, by=as.numeric(age %in% 1:2))
source('algorithm.R')
q()
qmod <- list(~s(age, k=3, by=breakpts(year, 2008)), ~s(age, k=3), ~s(age, k=3))
library(FLa4a)
stk.retro1 <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=15, age2=4, year2=15), qmodel=qmod, srmodel=srmod)
plot(stk.retro1)
stk.retro1 <- retro_gomcod(stk, idxs, retro=7, k=c(age=3, year=15, age2=4, year2=10), qmodel=qmod, srmodel=srmod)
plot(stk.retro1)
source('algorithm.R')
q()
